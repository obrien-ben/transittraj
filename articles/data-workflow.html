<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>data-workflow • transittraj</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="data-workflow">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">transittraj</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/input-data.html">Input Data</a></li>
    <li><a class="dropdown-item" href="../article/data-workflow.html">AVL Cleaning</a></li>
    <li><a class="dropdown-item" href="../article/trajectories.html">Intro to Trajectories</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/obrien-ben/transittraj/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>data-workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/obrien-ben/transittraj/blob/main/vignettes/data-workflow.Rmd" class="external-link"><code>vignettes/data-workflow.Rmd</code></a></small>
      <div class="d-none name"><code>data-workflow.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette, we will walk through <code>transittraj</code>’s
entire AVL cleaning and trajectory reconstruction workflow. Check out
<code><a href="../articles/input-data.html">vignette("input-data")</a></code> to learn more about the AVL and GTFS
data we’ll be using.</p>
<p>Let’s begin by loading the libraries we’ll be using:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/obrien-ben/transittraj" class="external-link">transittraj</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-transit/tidytransit" class="external-link">tidytransit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-0-setup">Step 0: Setup<a class="anchor" aria-label="anchor" href="#step-0-setup"></a>
</h2>
<p>We’ll begin by setting up the data we’re working with. We’ll be using
<code>wmata_avl</code> and <code>wmata_gtfs</code> for our TIDES AVL and
static GTFS input, respectively.</p>
<div class="section level3">
<h3 id="avl">AVL<a class="anchor" aria-label="anchor" href="#avl"></a>
</h3>
<p>For this example, we’ll work with WMATA’s bus route C53 in the
northbound direction. Let’s filter our AVL data to these
specifications:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53</span> <span class="op">&lt;-</span> <span class="st">"C53"</span></span>
<span><span class="va">c53_dir</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># 0 is NB, 1 is SB</span></span>
<span></span>
<span><span class="va">c53_avl</span> <span class="op">&lt;-</span> <span class="va">wmata_avl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">route_id</span> <span class="op">==</span> <span class="va">c53</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">direction_id</span> <span class="op">==</span> <span class="va">c53_dir</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now our dataset should include only northbound C53 trips. We can see
below that this window has about 5,400 individual GPS pings across 33
trips over 5 hours.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_avl</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">num_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">c53_avl</span><span class="op">$</span><span class="va">trip_id_performed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">time_span</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">c53_avl</span><span class="op">$</span><span class="va">event_timestamp</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">c53_avl</span><span class="op">$</span><span class="va">event_timestamp</span><span class="op">)</span>,</span>
<span>                   <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Total Observations: "</span>, <span class="va">total_obs</span>,</span>
<span>    <span class="st">"\nNumber of trips: "</span>, <span class="va">num_trips</span>,</span>
<span>    <span class="st">"\nTime span: "</span>, <span class="va">time_span</span>, <span class="st">" hr"</span>,</span>
<span>    sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; Total Observations: 5436</span></span>
<span><span class="co">#&gt; Number of trips: 33</span></span>
<span><span class="co">#&gt; Time span: 5.02 hr</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="gtfs">GTFS<a class="anchor" aria-label="anchor" href="#gtfs"></a>
</h3>
<p>Next, we should grab the GTFS shape and feed information we want for
this route and direction. <code>transittraj</code> provides two
functions to help with this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_gtfs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/filter_by_route.html">filter_by_route</a></span><span class="op">(</span>gtfs <span class="op">=</span> <span class="va">wmata_gtfs</span>,</span>
<span>                            route_ids <span class="op">=</span> <span class="va">c53</span>,</span>
<span>                            dir_id <span class="op">=</span> <span class="va">c53_dir</span><span class="op">)</span></span></code></pre></div>
<p>If we print a summary of this GTFS object, we’ll see that we have
only one route:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">c53_gtfs</span><span class="op">)</span></span>
<span><span class="co">#&gt; tidygtfs object</span></span>
<span><span class="co">#&gt; files        agency, routes, stop_times, trips, shapes, calendar, calendar_dates, stops</span></span>
<span><span class="co">#&gt; agency       WMATA</span></span>
<span><span class="co">#&gt; service      from 2025-12-14 to 2026-06-13</span></span>
<span><span class="co">#&gt; uses         stop_times (no frequencies)</span></span>
<span><span class="co">#&gt; # routes       1</span></span>
<span><span class="co">#&gt; # trips      952</span></span>
<span><span class="co">#&gt; # stop_ids    57</span></span>
<span><span class="co">#&gt; # stop_names  57</span></span>
<span><span class="co">#&gt; # shapes       2</span></span></code></pre></div>
<p>Now that we have the filtered GTFS, we must pull the shape we want as
a simple features (SF) spatial object. You will need to know two things
to do this:</p>
<ul>
<li><p>Your <code>shape_id</code>. As shown above, there are two
<code>shape_id</code>s assigned to the northbound C53. Check out
<code><a href="../reference/plot_interactive_gtfs.html">plot_interactive_gtfs()</a></code> to explore each shape individually
and decide which one is correct for you. Below we use
<code>shape_id = "C53:04"</code>.</p></li>
<li><p>A coordinate reference system. We recommend projecting all
spatial data into an appropriate Euclidian coordinate system. Below we
use the UTM zone for Washington, DC, Zone 18N (with an EPSG number of
32618).</p></li>
</ul>
<p>Below we use <code><a href="../reference/get_shape_geometry.html">get_shape_geometry()</a></code> to grab the
<code>shape_id</code> we want, turn it into a linestring, and project it
to an appropriate coordinate system:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_NB_shape_id</span> <span class="op">&lt;-</span> <span class="st">"C53:04"</span></span>
<span><span class="va">dc_CRS</span> <span class="op">&lt;-</span> <span class="fl">32618</span></span>
<span><span class="va">c53_shape</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_shape_geometry.html">get_shape_geometry</a></span><span class="op">(</span>gtfs <span class="op">=</span> <span class="va">c53_gtfs</span>,</span>
<span>                                shape <span class="op">=</span> <span class="va">c53_NB_shape_id</span>,</span>
<span>                                project_crs <span class="op">=</span> <span class="va">dc_CRS</span><span class="op">)</span></span></code></pre></div>
<p>Now, if we print the object, we’ll see that it is one multilinestring
with <code>shape_id = "C53:04"</code> and the coordinate system UTM
18N.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_shape</span><span class="op">)</span></span>
<span><span class="co">#&gt; Simple feature collection with 1 feature and 1 field</span></span>
<span><span class="co">#&gt; Geometry type: MULTILINESTRING</span></span>
<span><span class="co">#&gt; Dimension:     XY</span></span>
<span><span class="co">#&gt; Bounding box:  xmin: 322061.8 ymin: 4301418 xmax: 329233.3 ymax: 4310353</span></span>
<span><span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 18N</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 2</span></span></span>
<span><span class="co">#&gt;   shape_id                                                              geometry</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                                                    <span style="color: #949494; font-style: italic;">&lt;MULTILINESTRING [m]&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> C53:04   ((327507.1 4301484, 327505.6 4301478, 327504.9 4301473, 327504 43014…</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="visualizing-our-starting-data">Visualizing our Starting Data<a class="anchor" aria-label="anchor" href="#visualizing-our-starting-data"></a>
</h3>
<p>We now have all the data we need to proceed. But before we do, let’s
visualize the AVL point and route geometry so we understand what we’re
working with:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert GPS points to spatial objects</span></span>
<span><span class="va">c53_sf</span> <span class="op">&lt;-</span> <span class="va">c53_avl</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># As SF</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longitude"</span>, <span class="st">"latitude"</span><span class="op">)</span>,</span>
<span>           crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Project to DC</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">dc_CRS</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate a map</span></span>
<span><span class="va">avl_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Basemap from OSM</span></span>
<span>  <span class="fu">ggspatial</span><span class="fu">::</span><span class="fu"><a href="https://paleolimbot.github.io/ggspatial/reference/annotation_map_tile.html" class="external-link">annotation_map_tile</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"cartolight"</span>, zoomin <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                 progress <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Add alignment &amp; points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">c53_shape</span>, color <span class="op">=</span> <span class="st">"red"</span>, linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span> <span class="va">c53_sf</span>, color <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>          alpha <span class="op">=</span> <span class="fl">0.2</span>, size <span class="op">=</span> <span class="fl">.7</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format our map</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"C53 Shape &amp; AVL"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">avl_map</span></span></code></pre></div>
<p><img src="data-workflow_files/figure-html/unnamed-chunk-8-1.png" class="r-plt" alt="" width="80%" style="display: block; margin: auto;"></p>
<p>For the most part, our GPS pings follow the route alignment
excellently. But what’s the deal with the points off-route in the far
south? These pings roughly follow I-295 down to the Blue Plains
neighborhood. They end roughly at the location of WMATA’s <a href="https://maps.app.goo.gl/RWNECRptbsDovPBJA" class="external-link">Shepherd Parkway</a>
bus garage. The C53 is dispatched out of Shepherd, and most vehicles
take I-295 to get between Shepherd and their starting/ending
locations.</p>
<p>Knowing this, these points most likely correspond to one (or more)
deadheading vehicles that were logged into a trip but had not actually
started their run. This is a pretty common phenomenon across AVL
vendors. This demonstrates why you should always 1) visualize your data,
and 2) know the system you’re working with. <code>transittraj</code>
includes functions intended to identify and remove potential deadheads.
We’ll begin exploring these in the following section.</p>
</div>
</div>
<div class="section level2">
<h2 id="steps-1-2-buffer-linearize">Steps 1 &amp; 2: Buffer &amp; Linearize<a class="anchor" aria-label="anchor" href="#steps-1-2-buffer-linearize"></a>
</h2>
<p>Now that we have our data, we can begin cleaning and processesing it.
The first two steps we recommend are:</p>
<ul>
<li><p><strong>Step 1: Buffer</strong>. Clip GPS points to within a
certain distance of the route alignment.</p></li>
<li><p><strong>Step 2: Linearize</strong>. Project GPS points onto the
route alignment to retrieve the linear distance from the start of the
route.</p></li>
</ul>
<p>Both steps are bundled into one function,
<code><a href="../reference/get_linear_distances.html">get_linear_distances()</a></code>. There are two main decision
variables in this function:</p>
<ul>
<li><p>The projection CRS. This should be the same one you used to
create your route shape.</p></li>
<li><p>The buffer distance. This will be in the units of your spatial
projection. Here we’re using UTM, which is in meters. Thus, all distance
measurements you see in the vignette will be in meters.</p></li>
</ul>
<div class="section level3">
<h3 id="running-the-code">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code"></a>
</h3>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_buffer</span> <span class="op">=</span> <span class="fl">50</span> <span class="co"># meters</span></span>
<span><span class="va">c53_distances</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_linear_distances.html">get_linear_distances</a></span><span class="op">(</span>avl_df <span class="op">=</span> <span class="va">c53_avl</span>,</span>
<span>                                      shape_geometry <span class="op">=</span> <span class="va">c53_shape</span>,</span>
<span>                                      project_crs <span class="op">=</span> <span class="va">dc_CRS</span>,</span>
<span>                                      clip_buffer <span class="op">=</span> <span class="va">c53_buffer</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results"></a>
</h3>
<p>Now each observation is represented by a distance from the route’s
beginning. Let’s first see how many observations were clipped out:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step0_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_avl</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">step1_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_distances</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step0_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nAfter buffer: "</span>, <span class="va">step1_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step0_obs</span> <span class="op">-</span> <span class="va">step1_obs</span><span class="op">)</span>, <span class="st">" obs removed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial:  5436  obs </span></span>
<span><span class="co">#&gt; After buffer:  4946  obs </span></span>
<span><span class="co">#&gt; Difference:  490  obs removed</span></span></code></pre></div>
<p>We had just under 500 observations clipped out of our dataset.</p>
<p>We can also take a look at the new header of our dataset:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">c53_distances</span><span class="op">)</span></span>
<span><span class="co">#&gt;   location_ping_id vehicle_id trip_id_performed service_date route_id</span></span>
<span><span class="co">#&gt; 1                1       5461          18632100   2026-02-16      C53</span></span>
<span><span class="co">#&gt; 2                3       5464          14078100   2026-02-16      C53</span></span>
<span><span class="co">#&gt; 3                4       5466          25836100   2026-02-16      C53</span></span>
<span><span class="co">#&gt; 4                6       5473           8428100   2026-02-16      C53</span></span>
<span><span class="co">#&gt; 6                8       5481           1115100   2026-02-16      C53</span></span>
<span><span class="co">#&gt; 7                9       5479            842100   2026-02-16      C53</span></span>
<span><span class="co">#&gt;   direction_id   speed trip_stop_sequence     event_timestamp stop_id</span></span>
<span><span class="co">#&gt; 1            0  0.0000                 63 2026-02-16 10:58:09    7219</span></span>
<span><span class="co">#&gt; 2            0 10.9728                 52 2026-02-16 10:58:31    6843</span></span>
<span><span class="co">#&gt; 3            0  0.0000                  2 2026-02-16 10:58:27   13111</span></span>
<span><span class="co">#&gt; 4            0  4.5720                 63 2026-02-16 10:58:02    7219</span></span>
<span><span class="co">#&gt; 6            0  7.9248                 41 2026-02-16 10:58:10   28286</span></span>
<span><span class="co">#&gt; 7            0  8.8392                 29 2026-02-16 10:58:24    4520</span></span>
<span><span class="co">#&gt;       distance</span></span>
<span><span class="co">#&gt; 1 1.534625e+04</span></span>
<span><span class="co">#&gt; 2 1.205652e+04</span></span>
<span><span class="co">#&gt; 3 4.191312e-02</span></span>
<span><span class="co">#&gt; 4 1.535750e+04</span></span>
<span><span class="co">#&gt; 6 9.512327e+03</span></span>
<span><span class="co">#&gt; 7 6.551790e+03</span></span></code></pre></div>
<p>Now, instead of <code>latitude</code> and <code>longitude</code>
columns, we have a single numeric <code>distance</code> column.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-3-cleaning-overlapping-subtrips">Step 3: Cleaning Overlapping Subtrips<a class="anchor" aria-label="anchor" href="#step-3-cleaning-overlapping-subtrips"></a>
</h2>
<p>Under some AVL vendors, multiple vehicles (or operators) can have
multiple vehicle or operator IDs recorded for the same trip. Sometimes
this is okay: for example, there may be an operator shift change
mid-shift. Other times, however, these multiple vehicles/operators are
logged in at the same time (“overlapping”). This creates problems, as it
becomes impossible for <code>transittraj</code> to understand what the
trip is <em>supposed</em> to be doing.</p>
<p>The function <code><a href="../reference/clean_overlapping_subtrips.html">clean_overlapping_subtrips()</a></code> identifies and
removes these trips. There are a few key decision variables:</p>
<ul>
<li><p>Should operator IDs be checked? The WMATA dataset does not
include operator information, so we will not check this.</p></li>
<li><p>If a subtrip has only one observation assigned to it (i.e., one
observation for a unique combination of trip, vehicle, and operator),
should it be removed?</p></li>
<li><p>Should trips with multiple subtrips that do <em>not</em> overlap
be removed? For this dataset, it’s okay to leave these in.</p></li>
</ul>
<div class="section level3">
<h3 id="running-the-code-1">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code-1"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_cleaned_subtrips</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_overlapping_subtrips.html">clean_overlapping_subtrips</a></span><span class="op">(</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_distances</span>,</span>
<span>  check_operator <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  remove_single_observations <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  remove_non_overlapping <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results-1">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results-1"></a>
</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step3_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_cleaned_subtrips</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step1_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nAfter: "</span>, <span class="va">step3_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step1_obs</span> <span class="op">-</span> <span class="va">step3_obs</span><span class="op">)</span>, <span class="st">" obs removed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial:  4946  obs </span></span>
<span><span class="co">#&gt; After:  4945  obs </span></span>
<span><span class="co">#&gt; Difference:  1  obs removed</span></span></code></pre></div>
<p>We can see that only one observation violated our requirements. To
see what that observation is, we’ll introduce a new feature of
<code>transittraj</code>: the <code>return_removals</code> parameter.
Each cleaning function used in this vignette contains a parameter
<code>return_removals</code> that, when set to <code>TRUE</code>, will
return a dataframe of the point(s) removed through that step and a brief
explanation of what it was removed. Let’s check it out:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_step3_removals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_overlapping_subtrips.html">clean_overlapping_subtrips</a></span><span class="op">(</span></span>
<span>  <span class="co"># Same settigns as before</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_distances</span>, check_operator <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  remove_single_observations <span class="op">=</span> <span class="cn">TRUE</span>, remove_non_overlapping <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="co"># Return removals</span></span>
<span>  return_removals <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_step3_removals</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 7</span></span></span>
<span><span class="co">#&gt;   trip_id_performed subtrip   n_obs reason action time_range n_subtrips_in_range</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;iv&lt;dbl&gt;&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 8428100           8428100-…     1 singl… remov…   [NA, NA)                  <span style="color: #BB0000;">NA</span></span></span></code></pre></div>
<p>We can see the trip and subtrip
(<code>trip_id</code>-<code>vehicle_id</code>) which was removed, and
that it was removed because it was a single observation. Let’s see what
this trip looked like in the original dataset:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_distances</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="st">"8428100"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   location_ping_id vehicle_id trip_id_performed service_date route_id</span></span>
<span><span class="co">#&gt; 1                6       5473           8428100   2026-02-16      C53</span></span>
<span><span class="co">#&gt;   direction_id speed trip_stop_sequence     event_timestamp stop_id distance</span></span>
<span><span class="co">#&gt; 1            0 4.572                 63 2026-02-16 10:58:02    7219  15357.5</span></span></code></pre></div>
<p>This trip, in fact, only had one observation total. It makes sense to
remove this – we can’t do much with a single observation.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-4-clean-outlierjumps">Step 4: Clean Outlier/Jumps<a class="anchor" aria-label="anchor" href="#step-4-clean-outlierjumps"></a>
</h2>
<p>GPS data, especially in urban areas, is noisy. Sometimes that noise
manifests as a large instantaneous jump that does not match an
observation’s surroundings. The function <code><a href="../reference/clean_jumps.html">clean_jumps()</a></code>
detects and removes these using median filters. Read more about the
theory behind these filters using <code><a href="../reference/clean_jumps.html">help(clean_jumps)</a></code>.</p>
<p>For this example, we’ll do a very simple median filter using only
deviation from the median around each point. This has two main decision
variables:</p>
<ul>
<li><p>The neighborhood width, the total number of points to consider
around each observation. We’ll use the default, 7, here. This means each
window will consist of 3 points on either side of each
observation.</p></li>
<li><p>The maximum jump distance. We’ll use a maximum of 20 meters here.
This is quite conservative; the goal is simply to demonstrate the
idea.</p></li>
</ul>
<p>Note that for demonstration purposes, we’re using a very simple
median filter methodology. More options robust options, such as a Hampel
filter, are available through <code><a href="../reference/clean_jumps.html">clean_jumps()</a></code>.</p>
<div class="section level3">
<h3 id="running-the-code-2">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code-2"></a>
</h3>
<p>Let’s run <code><a href="../reference/clean_jumps.html">clean_jumps()</a></code> as discussed above. The only
input we need to change from its default is the maximum distance
deviation.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_max_jump</span> <span class="op">&lt;-</span> <span class="fl">20</span> <span class="co"># meters</span></span>
<span><span class="va">c53_min_jump</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="op">*</span> <span class="va">c53_max_jump</span> <span class="co"># meters</span></span>
<span><span class="va">c53_no_jumps</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_jumps.html">clean_jumps</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_cleaned_subtrips</span>,</span>
<span>                            max_median_deviation <span class="op">=</span> <span class="va">c53_max_jump</span>,</span>
<span>                            min_median_deviation <span class="op">=</span> <span class="va">c53_min_jump</span>,</span>
<span>                            t_cutoff <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results-2">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results-2"></a>
</h3>
<p>Let’s see how many points were removed as outliers from this
filter:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step4_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_no_jumps</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step3_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nAfter: "</span>, <span class="va">step4_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step3_obs</span> <span class="op">-</span> <span class="va">step4_obs</span><span class="op">)</span>, <span class="st">" obs removed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial:  4945  obs </span></span>
<span><span class="co">#&gt; After:  4934  obs </span></span>
<span><span class="co">#&gt; Difference:  11  obs removed</span></span></code></pre></div>
<p>We can use <code>return_removals = TRUE</code>, just like in Step 3,
to see which observations were removed:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_step4_removals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_jumps.html">clean_jumps</a></span><span class="op">(</span></span>
<span>  <span class="co"># Same settings as before</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_cleaned_subtrips</span>,</span>
<span>  neighborhood_width <span class="op">=</span> <span class="fl">7</span>,</span>
<span>  max_median_deviation <span class="op">=</span> <span class="va">c53_max_jump</span>, min_median_deviation <span class="op">=</span> <span class="va">c53_min_jump</span>,</span>
<span>  evaluate_implosions <span class="op">=</span> <span class="cn">FALSE</span>, evaluate_tails <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  t_cutoff <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>  <span class="co"># Return removals</span></span>
<span>  return_removals <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_step4_removals</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 13</span></span></span>
<span><span class="co">#&gt;    trip_id_performed event_timestamp       distance location_ping_id window_med</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> 1306100           2026-02-16 <span style="color: #949494;">12:43:47</span>  <span style="text-decoration: underline;">4</span>954.     16770                <span style="text-decoration: underline;">4</span>884. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> 1306100           2026-02-16 <span style="color: #949494;">12:43:57</span>  <span style="text-decoration: underline;">4</span>954.     16798                <span style="text-decoration: underline;">4</span>896. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> 1306100           2026-02-16 <span style="color: #949494;">12:44:05</span>  <span style="text-decoration: underline;">4</span>844.     16826                <span style="text-decoration: underline;">4</span>936. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> 1306100           2026-02-16 <span style="color: #949494;">12:44:35</span>  <span style="text-decoration: underline;">4</span>896.     16910                <span style="text-decoration: underline;">4</span>954. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> 1306100           2026-02-16 <span style="color: #949494;">13:31:22</span> <span style="text-decoration: underline;">13</span>819.     24579               <span style="text-decoration: underline;">13</span>789. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> 13478100          2026-02-16 <span style="color: #949494;">15:37:40</span>   108.     45428                  66.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> 35294100          2026-02-16 <span style="color: #949494;">11:28:14</span>    83.2    4721                   20.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> 35294100          2026-02-16 <span style="color: #949494;">11:32:14</span>     0.041<span style="text-decoration: underline;">9</span> 5369                   20.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> 35294100          2026-02-16 <span style="color: #949494;">11:37:49</span>     0.041<span style="text-decoration: underline;">9</span> 6260                   20.1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> 35294100          2026-02-16 <span style="color: #949494;">11:39:13</span>   257.     6476                   83.2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> 35294100          2026-02-16 <span style="color: #949494;">11:40:34</span>    11.2    6692                  214. </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 8 more variables: window_mad &lt;dbl&gt;, med_dist &lt;dbl&gt;, is_implosion &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   is_tail &lt;lgl&gt;, ignore_observation &lt;lgl&gt;, mad_ok &lt;lgl&gt;, dev_ok &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   all_ok &lt;lgl&gt;</span></span></span></code></pre></div>
<p>Let’s explore pings 16770 and 16798 from trip 1306100 as an example.
We can plot the trip in this area to visualize the outliers:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Filter dataframe to our tirp &amp; distances</span></span>
<span><span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="va">c53_cleaned_subtrips</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="st">"1306100"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">distance</span> <span class="op">&gt;=</span> <span class="fl">4500</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">distance</span> <span class="op">&lt;=</span> <span class="fl">5500</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join removals</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>y <span class="op">=</span> <span class="op">(</span><span class="va">c53_step4_removals</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location_ping_id</span>, <span class="va">all_ok</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"location_ping_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>all_ok <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">all_ok</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a plot</span></span>
<span><span class="va">jumps_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot the points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="va">all_ok</span>, shape <span class="op">=</span> <span class="va">all_ok</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Point OK?"</span>,</span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"firebrick"</span>,</span>
<span>                                <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Point OK?"</span>,</span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                <span class="st">"TRUE"</span> <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Distance (m)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Outliers on C53"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Trip 13478100"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">jumps_plot</span></span></code></pre></div>
<p><img src="data-workflow_files/figure-html/unnamed-chunk-19-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>This plot makes it pretty clear that some of these points are a bit
out of line. The final one removed may not truly be an outlier; we
recommend playing around with the function’s options to find settings
that make sense for your data. Again, there are a lot of customization
options and types of median filters available through this function.
Read more at <code><a href="../reference/clean_jumps.html">help(clean_jumps)</a></code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-5-clean-incomplete-trips">Step 5: Clean Incomplete Trips<a class="anchor" aria-label="anchor" href="#step-5-clean-incomplete-trips"></a>
</h2>
<p>AVL or GTFS-rt data is rarely transmitted perfectly. Often, there may
be large gaps of missing data in the middle of trips, or you may have
only a few observations from each trip.
<code><a href="../reference/clean_incomplete_trips.html">clean_incomplete_trips()</a></code> is designed to filter out these
scenarios. There are two main groups of decision variables for this
function:</p>
<ul>
<li><p>Minimum and maximum trip distances and durations.</p></li>
<li><p>Minimum and maximum gaps between adjacent observations.</p></li>
</ul>
<p>This function will remove the entirety of trips that violate your
decision variables.</p>
<div class="section level3">
<h3 id="running-the-code-3">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code-3"></a>
</h3>
<p>For this example, we’ll use a minimum trip distance of 500 meters,
and a minimum trip duration of 90 seconds. Anything will less data than
this will be filtered out. Additionally, we’ll remove trips with a gap
larger than 500 meters.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_min_dist</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># meters</span></span>
<span><span class="va">c53_min_time</span> <span class="op">&lt;-</span> <span class="fl">90</span> <span class="co"># seconds</span></span>
<span><span class="va">c53_max_gap</span> <span class="op">&lt;-</span> <span class="fl">500</span> <span class="co"># meters</span></span>
<span></span>
<span><span class="va">c53_cleaned_incompletes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_incomplete_trips.html">clean_incomplete_trips</a></span><span class="op">(</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_no_jumps</span>,</span>
<span>  min_trip_distance <span class="op">=</span> <span class="va">c53_min_dist</span>,</span>
<span>  min_trip_duration <span class="op">=</span> <span class="va">c53_min_time</span>,</span>
<span>  max_distance_gap <span class="op">=</span> <span class="va">c53_max_gap</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results-3">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results-3"></a>
</h3>
<p>Now that we’ve filtered our dataset, let’s see how many trips have
been removed:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step5_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_cleaned_incompletes</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">step5_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">c53_cleaned_incompletes</span><span class="op">$</span><span class="va">trip_id_performed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">step4_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">c53_no_jumps</span><span class="op">$</span><span class="va">trip_id_performed</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step4_obs</span>, <span class="st">" obs, "</span>, <span class="va">step4_trips</span>, <span class="st">" trips"</span>,</span>
<span>    <span class="st">"\nAfter: "</span>, <span class="va">step5_obs</span>, <span class="st">" obs, "</span>, <span class="va">step5_trips</span>, <span class="st">" trips"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step4_obs</span> <span class="op">-</span> <span class="va">step5_obs</span><span class="op">)</span>, <span class="st">" obs, "</span>,</span>
<span>    <span class="op">(</span><span class="va">step4_trips</span> <span class="op">-</span> <span class="va">step5_trips</span><span class="op">)</span>, <span class="st">" trips removed"</span>,</span>
<span>    sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial: 4934 obs, 31 trips</span></span>
<span><span class="co">#&gt; After: 4089 obs, 24 trips</span></span>
<span><span class="co">#&gt; Difference: 845 obs, 7 trips removed</span></span></code></pre></div>
<p>7 trips violated our requirements, corresponding to roughly 850
individual observations. As before, we can use
<code>return_removals</code> to take a look at the violating trips:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_step5_removals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/clean_incomplete_trips.html">clean_incomplete_trips</a></span><span class="op">(</span></span>
<span>  <span class="co"># Same settings as before</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_no_jumps</span>,</span>
<span>  min_trip_distance <span class="op">=</span> <span class="va">c53_min_dist</span>, min_trip_duration <span class="op">=</span> <span class="va">c53_min_time</span>,</span>
<span>  max_distance_gap <span class="op">=</span> <span class="va">c53_max_gap</span>,</span>
<span>  <span class="co"># Return removals</span></span>
<span>  return_removals <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_step5_removals</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 × 16</span></span></span>
<span><span class="co">#&gt;   trip_id_performed max_dist   min_dist max_time            min_time           </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>             </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 13927100              127.     0      2026-02-16 <span style="color: #949494;">14:36:57</span> 2026-02-16 <span style="color: #949494;">14:36:27</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 14639100            <span style="text-decoration: underline;">15</span>362.     0      2026-02-16 <span style="color: #949494;">12:38:36</span> 2026-02-16 <span style="color: #949494;">11:38:49</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 18632100            <span style="text-decoration: underline;">15</span>360. <span style="text-decoration: underline;">15</span>346.     2026-02-16 <span style="color: #949494;">11:02:20</span> 2026-02-16 <span style="color: #949494;">10:58:09</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 21956100            <span style="text-decoration: underline;">13</span>803.   248.     2026-02-16 <span style="color: #949494;">15:59:17</span> 2026-02-16 <span style="color: #949494;">14:45:27</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 5516100             <span style="text-decoration: underline;">15</span>259.     0.041<span style="text-decoration: underline;">9</span> 2026-02-16 <span style="color: #949494;">15:12:19</span> 2026-02-16 <span style="color: #949494;">13:52:44</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 6533100             <span style="text-decoration: underline;">12</span>118.     0.041<span style="text-decoration: underline;">9</span> 2026-02-16 <span style="color: #949494;">15:59:17</span> 2026-02-16 <span style="color: #949494;">14:52:21</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> 7879100             <span style="text-decoration: underline;">15</span>363.     0.041<span style="text-decoration: underline;">9</span> 2026-02-16 <span style="color: #949494;">14:41:08</span> 2026-02-16 <span style="color: #949494;">13:26:33</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 11 more variables: max_dist_gap &lt;dbl&gt;, max_t_gap &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   max_dist_gap_id &lt;chr&gt;, max_t_gap_id &lt;chr&gt;, trip_distance &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   duration &lt;dbl&gt;, dist_ok &lt;lgl&gt;, dur_ok &lt;lgl&gt;, dist_gap_ok &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   t_gap_ok &lt;lgl&gt;, all_ok &lt;lgl&gt;</span></span></span></code></pre></div>
<p>Most of these were removed because of a large gap in data. Let’s take
a look at one, trip 21956100:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Filter dataframe to our tirp &amp; distances</span></span>
<span><span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="va">c53_cleaned_subtrips</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="st">"21956100"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">distance</span> <span class="op">&gt;=</span> <span class="fl">11000</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">distance</span> <span class="op">&lt;=</span> <span class="fl">14000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a plot</span></span>
<span><span class="va">gaps_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot the points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df</span>,</span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span><span class="op">)</span>,</span>
<span>            linewidth <span class="op">=</span> <span class="fl">0.8</span>, color <span class="op">=</span> <span class="st">"indianred"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">0.8</span>, color <span class="op">=</span> <span class="st">"firebrick"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Distance (m)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Gap on C53"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Trip 21956100"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gaps_plot</span></span></code></pre></div>
<p><img src="data-workflow_files/figure-html/unnamed-chunk-23-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>We can see this trip’s large gap around 12,500 meters. The slope of
this line is a bit steep, but is not unreasonable; it seems a few
GTFS-rt pings just went missing here somehow. When we go to reconstruct
a trajectory curve later, it may not be reasonable to interpolate
between these points over such a large gap, so we’ll leave this trip out
of our future analyses.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-6-trim-trip-tails">Step 6: Trim Trip Tails<a class="anchor" aria-label="anchor" href="#step-6-trim-trip-tails"></a>
</h2>
<p>Earlier in this vignette, we used a spatial buffer to clean what
appeared to be deadheads. But what if a trip deadheads close to – or
along – the route alignment? The function <code><a href="../reference/trim_trips.html">trim_trips()</a></code> is
designed to handle these scenarios by trimming the tails off of
trips.</p>
<p>The function identifies the observations with the minimum and maximum
distance values, and removes any observations which occur before/after
these points. There is one main decision variable here: should beginning
trail be trimmed, ending tails, or both?</p>
<div class="section level3">
<h3 id="running-the-code-4">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code-4"></a>
</h3>
<p>For this example, we’ll trim both ends of trips:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_trimmed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trim_trips.html">trim_trips</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_cleaned_incompletes</span>,</span>
<span>                          trim_type <span class="op">=</span> <span class="st">"both"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results-4">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results-4"></a>
</h3>
<p>Let’s see what was removed:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step6_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_trimmed</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step5_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nAfter: "</span>, <span class="va">step6_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step5_obs</span> <span class="op">-</span> <span class="va">step6_obs</span><span class="op">)</span>, <span class="st">" obs removed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial:  4089  obs </span></span>
<span><span class="co">#&gt; After:  4086  obs </span></span>
<span><span class="co">#&gt; Difference:  3  obs removed</span></span></code></pre></div>
<p>For this dataset, it looks like there were no long deadheads along
the route alignment. Whether this function will make a difference will
largely depend on the dataset and routes you’re working with. Let’s take
a look at a the points removed:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_step6_removals</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trim_trips.html">trim_trips</a></span><span class="op">(</span></span>
<span>  <span class="co"># Same settings as before</span></span>
<span>  distance_df <span class="op">=</span> <span class="va">c53_cleaned_incompletes</span>, trim_type <span class="op">=</span> <span class="st">"both"</span>,</span>
<span>  <span class="co"># Return removals</span></span>
<span>  return_removals <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_step6_removals</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 10</span></span></span>
<span><span class="co">#&gt;   trip_id_performed event_timestamp     distance min_dist_index max_dist_index</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dttm&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 13478100          2026-02-16 <span style="color: #949494;">15:59:11</span>   <span style="text-decoration: underline;">2</span>447.               1             88</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 35294100          2026-02-16 <span style="color: #949494;">11:26:04</span>     18.8              3            202</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 35294100          2026-02-16 <span style="color: #949494;">11:26:34</span>     94.3              3            202</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 5 more variables: row_index &lt;int&gt;, before_min &lt;lgl&gt;, after_max &lt;lgl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   obs_ok &lt;lgl&gt;, location_ping_id &lt;chr&gt;</span></span></span></code></pre></div>
<p>Plotting the points removed along trip 35294100:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Filter dataframe to our tirp &amp; distances</span></span>
<span><span class="va">plot_df</span> <span class="op">&lt;-</span> <span class="va">c53_cleaned_incompletes</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="st">"35294100"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">distance</span> <span class="op">&lt;=</span> <span class="fl">200</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Join removals</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>y <span class="op">=</span> <span class="op">(</span><span class="va">c53_step6_removals</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">location_ping_id</span>, <span class="va">obs_ok</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"location_ping_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>obs_ok <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">obs_ok</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a plot</span></span>
<span><span class="va">trimmed_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot the points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="va">obs_ok</span>, shape <span class="op">=</span> <span class="va">obs_ok</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the points</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Point OK?"</span>,</span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="st">"firebrick"</span>,</span>
<span>                                <span class="st">"TRUE"</span> <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_shape_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Point OK?"</span>,</span>
<span>                     values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FALSE"</span> <span class="op">=</span> <span class="fl">4</span>,</span>
<span>                                <span class="st">"TRUE"</span> <span class="op">=</span> <span class="fl">16</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Distance (m)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Trimmed Trips on C53"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Trip 35294100"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">trimmed_plot</span></span></code></pre></div>
<p><img src="data-workflow_files/figure-html/unnamed-chunk-27-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>As noted before, this does not seem to be a long deadhead; just some
noise at the beginning of the route (by default,
<code><a href="../reference/clean_jumps.html">clean_jumps()</a></code> does not look for jumps at the beginning/end
of trips before a complete median window can be formed). Whether this
step is truly necessary will depend on your dataset.</p>
</div>
</div>
<div class="section level2">
<h2 id="step-7-correct-for-monotonicity">Step 7: Correct for Monotonicity<a class="anchor" aria-label="anchor" href="#step-7-correct-for-monotonicity"></a>
</h2>
<p>While GPS noise can result in the large jumps we saw previously, it
much more often causes small deviations in observed locations. This
creates problems when fitting an interpolating trajectory curve, because
if any points drift backwards, the curve will be neither monotonic nor
invertible. The seventh (and final!) cleaning step is to “pull”
backtracking points back upwards. Optionally, data can also be made
<em>strictly</em> monotonic.</p>
<p>The function <code><a href="../reference/make_monotonic.html">make_monotonic()</a></code> has two decision
variables:</p>
<ul>
<li><p>Should speeds be corrected to satisfy monotonicity? AVL speed
location can help fit an excellent interpolating curve, but the values
of observed speeds must meet certain coditions (known as <a href="https://epubs.siam.org/doi/10.1137/0717021" class="external-link">Fritsch-Carlson
constraints</a>) to produce a monotonic spline. If your AVL data has
speeds information, and you plan to use it when fitting a spline (the
recommend interpolation method), set <code>correct_speed = TRUE</code>
to guarantee the fit is monotonic.</p></li>
<li><p>Should the trajectory be made <em>strictly</em> monotonic? This
will identify perfectly flat regions can give them a slight upward
slope. To be invertible, a trajectory must be strictly increasing, and
never constant.</p></li>
</ul>
<p>More information is available at
<code><a href="../reference/make_monotonic.html">help(make_monotonic)</a></code>.</p>
<div class="section level3">
<h3 id="running-the-code-5">Running the Code<a class="anchor" aria-label="anchor" href="#running-the-code-5"></a>
</h3>
<p>Our AVL dataset does have speeds, and we do want an invertible and
monotonic final trajectory. As such, we’ll correct the speeds to meet
the Fritsch-Carlson constraints, and we will add a distance error of
0.001 meters (or 1 mm).</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_dist_error</span> <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="va">c53_mono</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_monotonic.html">make_monotonic</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_trimmed</span>,</span>
<span>                           correct_speed <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                           add_distance_error <span class="op">=</span> <span class="va">c53_dist_error</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="exploring-the-results-5">Exploring the Results<a class="anchor" aria-label="anchor" href="#exploring-the-results-5"></a>
</h3>
<p>This function modifies existing data, but does not remove any points.
The total number of observations should stay the same:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">step7_obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">c53_mono</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Initial: "</span>, <span class="va">step6_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nAfter: "</span>, <span class="va">step7_obs</span>, <span class="st">" obs"</span>,</span>
<span>    <span class="st">"\nDifference: "</span>, <span class="op">(</span><span class="va">step6_obs</span> <span class="op">-</span> <span class="va">step7_obs</span><span class="op">)</span>, <span class="st">" obs removed"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Initial:  4086  obs </span></span>
<span><span class="co">#&gt; After:  4086  obs </span></span>
<span><span class="co">#&gt; Difference:  0  obs removed</span></span></code></pre></div>
<p>We can check, though, if our dataset is now monotonic using
<code><a href="../reference/validate_monotonicity.html">validate_monotonicity()</a></code>. We’ll ask the function to validate
speeds as well:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trimmed DF</span></span>
<span><span class="va">step6_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate_monotonicity.html">validate_monotonicity</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_trimmed</span>,</span>
<span>                                   check_speed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">step6_val</span><span class="op">)</span></span>
<span><span class="co">#&gt;   weak strict  speed </span></span>
<span><span class="co">#&gt;  FALSE  FALSE  FALSE</span></span>
<span></span>
<span><span class="co"># Monotonic-corrected DF</span></span>
<span><span class="va">step7_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/validate_monotonicity.html">validate_monotonicity</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_mono</span>,</span>
<span>                                   check_speed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">step7_val</span><span class="op">)</span></span>
<span><span class="co">#&gt;   weak strict  speed </span></span>
<span><span class="co">#&gt;   TRUE   TRUE   TRUE</span></span></code></pre></div>
<p>We can see the trimmed dataset did not satisfy weak, strict, or
Fristch-Carlson speed conditions for monotonicity, but the corrected
dataset did. Let’s visualize how these corrections affected our data by
plotting an example trip:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set filter parameters</span></span>
<span><span class="co">#plot_trip &lt;- "1306100"</span></span>
<span><span class="va">plot_trip</span> <span class="op">&lt;-</span> <span class="st">"21499100"</span></span>
<span><span class="co">#plot_dists &lt;- c(13500, 14000)</span></span>
<span><span class="va">plot_dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13700</span>, <span class="fl">13950</span><span class="op">)</span></span>
<span><span class="co"># Get old DF</span></span>
<span><span class="va">plot_df_before</span> <span class="op">&lt;-</span> <span class="va">c53_trimmed</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="va">plot_trip</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">distance</span> <span class="op">&gt;=</span> <span class="va">plot_dists</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">distance</span> <span class="op">&lt;=</span> <span class="va">plot_dists</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>speed_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">speed</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"m/s"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Get corrected DF</span></span>
<span><span class="va">plot_df_after</span> <span class="op">&lt;-</span> <span class="va">c53_mono</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">trip_id_performed</span> <span class="op">==</span> <span class="va">plot_trip</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">(</span><span class="va">distance</span> <span class="op">&gt;=</span> <span class="va">plot_dists</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;</span> <span class="op">(</span><span class="va">distance</span> <span class="op">&lt;=</span> <span class="va">plot_dists</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>speed_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">speed</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">" m/s"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot</span></span>
<span><span class="va">mono_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df_before</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Uncorrected"</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">2</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df_after</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Corrected"</span><span class="op">)</span>,</span>
<span>             size <span class="op">=</span> <span class="fl">1</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_label</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df_before</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Uncorrected"</span>, label <span class="op">=</span> <span class="va">speed_label</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="op">-</span><span class="fl">15</span>, size <span class="op">=</span> <span class="fl">1</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_label</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">plot_df_after</span>,</span>
<span>             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">event_timestamp</span>, y <span class="op">=</span> <span class="va">distance</span>,</span>
<span>                 color <span class="op">=</span> <span class="st">"Corrected"</span>, label <span class="op">=</span> <span class="va">speed_label</span><span class="op">)</span>,</span>
<span>            nudge_y <span class="op">=</span> <span class="fl">15</span>, size <span class="op">=</span> <span class="fl">1</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Correction"</span>,</span>
<span>                     values<span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Uncorrected"</span> <span class="op">=</span> <span class="st">"indianred"</span>,</span>
<span>                                <span class="st">"Corrected"</span> <span class="op">=</span> <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Format the plot</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Time"</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Distance (m)"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Monotonic Correction on C53"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Trip "</span>, <span class="va">plot_trip</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mono_plot</span></span></code></pre></div>
<p><img src="data-workflow_files/figure-html/unnamed-chunk-32-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>In this trip, the GPS pings backtrack slightly while the bus is
supposed to be stopped. The speeds are also larger than is physically
feasible for a monotonic trajectory as the bus enters and leaves this
stop. <code><a href="../reference/make_monotonic.html">make_monotonic()</a></code> identified and corrected both
issues.</p>
</div>
</div>
<div class="section level2">
<h2 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h2>
<p>That was a lot of cleaning! But we now have a dataset free of
outliers and deadheading trips, and that we know will produce a
monotonic and invertible trajectory function. In the next vignette, we
will fit and explore these interpolating curves.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin O’Brien, Lewis Lehe.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
