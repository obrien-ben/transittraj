<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Introduction to Trajectory Objects • transittraj</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Trajectory Objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">transittraj</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Data</h6></li>
    <li><a class="dropdown-item" href="../articles/input-data.html">Overview of Data</a></li>
    <li><a class="dropdown-item" href="../articles/data-workflow.html">AVL Cleaning</a></li>
    <li><h6 class="dropdown-header" data-toc-skip>Trajectories</h6></li>
    <li><a class="dropdown-item" href="../articles/trajectories.html">Intro to Trajectories</a></li>
    <li><a class="dropdown-item" href="../articles/trajectory-objects.html">Understanding Trajectory Objects</a></li>
    <li><a class="dropdown-item" href="../articles/plotting-trajectories.html">Plotting Trajectories</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/obrien-ben/transittraj/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Introduction to Trajectory Objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/obrien-ben/transittraj/blob/main/vignettes/trajectories.Rmd" class="external-link"><code>vignettes/trajectories.Rmd</code></a></small>
      <div class="d-none name"><code>trajectories.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In the previous vignette, we saw how we can use
<code>transittraj</code> to clean our AVL data. We took care of
outliers, deadheading trips, noise and non-monotonic observations, and
more. In this vignette, we’ll apply the cleaned data
(<code>c53_mono</code>) to fit a trajectory function.</p>
<p>Let’s begin by loading the library we’ll be using:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/obrien-ben/transittraj" class="external-link">transittraj</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-transit/tidytransit" class="external-link">tidytransit</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="fitting-a-trajectory-curve">Fitting a Trajectory Curve<a class="anchor" aria-label="anchor" href="#fitting-a-trajectory-curve"></a>
</h2>
<p>Our ultimate goal is to fit an interpolating curve describing the
position of a transit vehicle at any point in time. Ideally, we could
fit an inverse curve, giving us the time the transit vehicle passes any
point in space. We can do both using
<code><a href="../reference/get_trajectory_fun.html">get_trajectory_fun()</a></code>.</p>
<p><code>transittraj</code> supports many different methods for fitting
these functions. The simplest is linear interpolation without an
inverse. If this is all you need, you can probably skip many of the
cleaning steps from the previous vignette. For more fine-grained
analyses, though, we recommend fitting a <em>velocity-informed piecewise
cubic interpolating polynomial</em>. This uses the speeds and distances,
correct for monotonicity, to fit a cubic spline between each
observation. By default, <code><a href="../reference/get_trajectory_fun.html">get_trajectory_fun()</a></code> will fit this
type of interpolating curve (<code>interp_method = "monoH.FC"</code> and
<code>use_speeds = TRUE</code>).</p>
<p>Using the data we cleaned in the previous vignette, let’s finally fit
our trajectory functions:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_traj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_trajectory_fun.html">get_trajectory_fun</a></span><span class="op">(</span>distance_df <span class="op">=</span> <span class="va">c53_mono</span>,</span>
<span>                               interp_method <span class="op">=</span> <span class="st">"monoH.FC"</span>,</span>
<span>                               use_speeds <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                               find_inverse_fun <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>And that’s it! Once your data is cleaned, fitting the trajectory is
quick and easy; we’ve already done most of the heavy lifting.</p>
</div>
<div class="section level2">
<h2 id="exploring-the-trajectory-object">Exploring the Trajectory Object<a class="anchor" aria-label="anchor" href="#exploring-the-trajectory-object"></a>
</h2>
<p><code>transittraj</code> stores the fit curves in a special object
class. This object stores a list of fit trajectories, one for each trip,
as well as the time and distances ranges for each trip. We can use
<code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> to take a look inside the object:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">c53_traj</span><span class="op">)</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; AVL Group Trajectory Object</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; Number of trips: 24</span></span>
<span><span class="co">#&gt; Total distance range: 0 to 15370.75</span></span>
<span><span class="co">#&gt; Total time range: 1771257490 to 1771275553</span></span>
<span><span class="co">#&gt; ------</span></span>
<span><span class="co">#&gt; Trajectory function present: TRUE</span></span>
<span><span class="co">#&gt;    --&gt; Trajectory interpolation method: monoH.FC</span></span>
<span><span class="co">#&gt;    --&gt; Maximum derivative: 3</span></span>
<span><span class="co">#&gt;    --&gt; Fit with speeds: TRUE</span></span>
<span><span class="co">#&gt; Inverse function present: TRUE</span></span>
<span><span class="co">#&gt;    --&gt; Inverse function tolerance: 0.01</span></span>
<span><span class="co">#&gt; ------</span></span></code></pre></div>
<p>You’ll notice the summary also contains information about the
parameters we used to fit the curve.</p>
</div>
<div class="section level2">
<h2 id="interpolating">Interpolating<a class="anchor" aria-label="anchor" href="#interpolating"></a>
</h2>
<p>How do you use the fit curve to actually interpolate at new points?
We recommend using <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, as this will ensure that the
curves aren’t used to extrapolate beyond the range of each trip. Using
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, there are three main values we can interpolate
for: time from distances (requires an inverse function), distances from
times, and speeds from times (requires a spline).</p>
<div class="section level3">
<h3 id="interpolating-for-times">Interpolating for Times<a class="anchor" aria-label="anchor" href="#interpolating-for-times"></a>
</h3>
<p>One of the most common applications of the fit trajectory curve is to
find the time at which each vehicle passed a point along its route. To
do this, we’ll use <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> with the
<code>new_distances</code> parameter. We’ll begin by finding the
distance of each stop along the route using
<code><a href="../reference/get_stop_distances.html">get_stop_distances()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># First, use stop_times to find which stop_ids are timepoints</span></span>
<span><span class="va">c53_timepoints</span> <span class="op">&lt;-</span> <span class="va">c53_gtfs</span><span class="op">$</span><span class="va">stop_times</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">stop_id</span>, <span class="va">timepoint</span><span class="op">)</span></span>
<span><span class="co"># Now, find stop distances and join the timepoints column</span></span>
<span><span class="va">c53_stops</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_stop_distances.html">get_stop_distances</a></span><span class="op">(</span>gtfs <span class="op">=</span> <span class="va">c53_gtfs</span>,</span>
<span>                                shape_geometry <span class="op">=</span> <span class="va">c53_shape</span>,</span>
<span>                                project_crs <span class="op">=</span> <span class="va">dc_CRS</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">c53_timepoints</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"stop_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span>y <span class="op">=</span> <span class="op">(</span><span class="va">c53_gtfs</span><span class="op">$</span><span class="va">stops</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">stop_id</span>, <span class="va">stop_name</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            by <span class="op">=</span> <span class="st">"stop_id"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">shape_id</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>timepoint <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span>condition <span class="op">=</span> <span class="op">(</span><span class="va">timepoint</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                             true <span class="op">=</span> <span class="st">"Yes"</span>,</span>
<span>                             false <span class="op">=</span> <span class="st">"No"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">c53_stops</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 4</span></span></span>
<span><span class="co">#&gt;   stop_id distance timepoint stop_name                  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2584        677. No        Alabama Av SE+15 Pl SE     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2609        880. No        Alabama Av SE+Stanton Rd SE</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2683       <span style="text-decoration: underline;">1</span>155. No        Alabama Av SE+18 Pl SE     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2793       <span style="text-decoration: underline;">1</span>605. No        Alabama Av SE+22 St SE     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2811       <span style="text-decoration: underline;">1</span>807. No        Alabama Av SE+24 St SE     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2867       <span style="text-decoration: underline;">2</span>037. No        Alabama Av SE+Jasper St SE</span></span></code></pre></div>
<p>Now that we have some distances, let’s interpolate using
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_stop_crossings</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  new_distances <span class="op">=</span> <span class="va">c53_stops</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">c53_stop_crossings</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   stop_id distance timepoint stop_name              trip_id_performed     interp</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> 2584        677. No        Alabama Av SE+15 Pl SE 10185100              1.77<span style="color: #949494;">e</span>9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> 2584        677. No        Alabama Av SE+15 Pl SE 10249100              1.77<span style="color: #949494;">e</span>9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> 2584        677. No        Alabama Av SE+15 Pl SE 1306100               1.77<span style="color: #949494;">e</span>9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> 2584        677. No        Alabama Av SE+15 Pl SE 13437100              1.77<span style="color: #949494;">e</span>9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> 2584        677. No        Alabama Av SE+15 Pl SE 13478100              1.77<span style="color: #949494;">e</span>9</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> 2584        677. No        Alabama Av SE+15 Pl SE 1699100               1.77<span style="color: #949494;">e</span>9</span></span></code></pre></div>
<p>And now we have the crossing time (labeled <code>interp</code>) at
each stop, for each trip! The interpolated times are in seconds of epoch
time.</p>
</div>
<div class="section level3">
<h3 id="interpolating-for-distances">Interpolating for Distances<a class="anchor" aria-label="anchor" href="#interpolating-for-distances"></a>
</h3>
<p>Let’s say you want to know where every vehicle is at a certain point
in time. We can do that by providing <code>new_times</code> to
<code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>. Let’s see below:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_time_interp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  new_times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1771265000</span>, <span class="fl">1771275000</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_time_interp</span><span class="op">)</span></span>
<span><span class="co">#&gt;   event_timestamp trip_id_performed     interp</span></span>
<span><span class="co">#&gt; 1      1771265000           1306100  8933.8531</span></span>
<span><span class="co">#&gt; 2      1771265000          18298100 10899.0966</span></span>
<span><span class="co">#&gt; 3      1771265000          21499100  4006.3031</span></span>
<span><span class="co">#&gt; 4      1771265000          21555100 13912.1101</span></span>
<span><span class="co">#&gt; 5      1771265000          22663100  6944.8919</span></span>
<span><span class="co">#&gt; 6      1771275000          10185100  2883.3087</span></span>
<span><span class="co">#&gt; 7      1771275000          10249100  7986.3226</span></span>
<span><span class="co">#&gt; 8      1771275000          13478100   140.0436</span></span>
<span><span class="co">#&gt; 9      1771275000           3597100  6792.4405</span></span></code></pre></div>
<p>Here, <code>interp</code> will be the distance in meters from the
route’s beginning. You’ll notice that, even though we have 24 trips,
there were only four to five distance for each timepoint. This is
because <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> will only interpolate a distance for
trips that were actually running at that point in time.</p>
</div>
<div class="section level3">
<h3 id="interpolating-for-speeds">Interpolating for Speeds<a class="anchor" aria-label="anchor" href="#interpolating-for-speeds"></a>
</h3>
<p>The last thing we can interpolate for is the speed at any given point
in time. We can control this by setting the <code>deriv</code> parameter
in <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">c53_speed_interp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  new_times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1771265000</span>, <span class="fl">1771275000</span><span class="op">)</span>,</span>
<span>  deriv <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">c53_speed_interp</span><span class="op">)</span></span>
<span><span class="co">#&gt;   event_timestamp trip_id_performed       interp</span></span>
<span><span class="co">#&gt; 1      1771265000           1306100 1.675073e-01</span></span>
<span><span class="co">#&gt; 2      1771265000          18298100 1.464849e+00</span></span>
<span><span class="co">#&gt; 3      1771265000          21499100 1.372977e+01</span></span>
<span><span class="co">#&gt; 4      1771265000          21555100 6.424041e-01</span></span>
<span><span class="co">#&gt; 5      1771265000          22663100 1.508816e+00</span></span>
<span><span class="co">#&gt; 6      1771275000          10185100 4.473051e-01</span></span>
<span><span class="co">#&gt; 7      1771275000          10249100 4.354498e-05</span></span>
<span><span class="co">#&gt; 8      1771275000          13478100 7.213864e-01</span></span>
<span><span class="co">#&gt; 9      1771275000           3597100 9.079446e-01</span></span></code></pre></div>
<p>Here, <code>interp</code> will be the speed in meters per second.
Finding speeds requires starting from time values.</p>
</div>
</div>
<div class="section level2">
<h2 id="visualizing-trajectories">Visualizing Trajectories<a class="anchor" aria-label="anchor" href="#visualizing-trajectories"></a>
</h2>
<div class="section level3">
<h3 id="quick-plots">Quick Plots<a class="anchor" aria-label="anchor" href="#quick-plots"></a>
</h3>
<p>Now its time for the <em>really</em> fun part – plotting our
trajectory curves. We can use <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> to generate a quick
and easy plot of all trajectories:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">c53_traj</span><span class="op">)</span></span></code></pre></div>
<p><img src="trajectories_files/figure-html/unnamed-chunk-9-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> is intended for quick visualizations of
trajectories, and as such does not allow for much customization. In the
next section, we’ll use <code><a href="../reference/plot_trajectory.html">plot_trajectory()</a></code> to create more
interesting plots.</p>
</div>
<div class="section level3">
<h3 id="detailed-trajectories">Detailed Trajectories<a class="anchor" aria-label="anchor" href="#detailed-trajectories"></a>
</h3>
<p>To add features (such as stops) and customize formatting, we
recommend using <code><a href="../reference/plot_trajectory.html">plot_trajectory()</a></code>. This function starts of
similar to <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, taking a trajectory object. After that,
you can add a dataframe of feature distances, such as the
<code>c53_stops</code> we made ealier. Finally, formatting can be
controlled using mapping dataframes. The colors and linetypes of both
trajectories and features can be mapped to attributes using something
similar to what is below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stop_formatting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>timepoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,</span>
<span>                              color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"firebrick"</span>, <span class="st">"grey50"</span><span class="op">)</span>,</span>
<span>                              linetype <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"longdash"</span>, <span class="st">"dashed"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For mapping dataframes, at least one column must match the layer
being mapped to (trajectories or features). The other columns must be
<code>color</code> and/or <code>linetype</code>, telling
<code>transittraj</code> which feature they describe.</p>
<p>We can plug all that in to <code><a href="../reference/plot_trajectory.html">plot_trajectory()</a></code> to generate
our formatted plot:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">traj_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_trajectory.html">plot_trajectory</a></span><span class="op">(</span></span>
<span>  trajectory <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  feature_distances <span class="op">=</span> <span class="va">c53_stops</span>,</span>
<span>  feature_color <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_type <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_width <span class="op">=</span> <span class="fl">0.2</span>, feature_alpha <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  traj_width <span class="op">=</span> <span class="fl">0.4</span>, traj_alpha <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">traj_plot</span></span></code></pre></div>
<p><img src="trajectories_files/figure-html/unnamed-chunk-11-1.png" class="r-plt" alt="" width="100%" style="display: block; margin: auto;"></p>
<p>Check out <code><a href="../reference/plot_trajectory.html">help(plot_trajectory)</a></code> for a full discussion of
the plotting features available.</p>
<p>The benefits of the fitting</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">am_lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">13900</span>, <span class="fl">14600</span><span class="op">)</span></span>
<span><span class="va">traj_plot2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_trajectory.html">plot_trajectory</a></span><span class="op">(</span></span>
<span>  trajectory <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  feature_distances <span class="op">=</span> <span class="va">c53_stops</span>,</span>
<span>  feature_color <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_type <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_width <span class="op">=</span> <span class="fl">1</span>, feature_alpha <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>  traj_width <span class="op">=</span> <span class="fl">0.6</span>, traj_alpha <span class="op">=</span> <span class="fl">0.6</span>,</span>
<span>  traj_color <span class="op">=</span> <span class="st">"firebrick"</span>,</span>
<span>  center_trajectories <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  distance_lim <span class="op">=</span> <span class="va">am_lims</span></span>
<span><span class="op">)</span></span>
<span><span class="va">traj_plot2</span></span></code></pre></div>
<p><img src="trajectories_files/figure-html/unnamed-chunk-12-1.png" class="r-plt" alt="" width="700"></p>
</div>
<div class="section level3">
<h3 id="line-animations">Line Animations<a class="anchor" aria-label="anchor" href="#line-animations"></a>
</h3>
<p>Another fun way to visualize transit vehicle trajectories is to
animate them. Use <code>plot_line_animation()</code> to animate
vehicles, as points, moving along a straight line that represents the
route.</p>
<p>The formatting process works very similarly with
<code>plot_line_animation()</code> as it does with
<code>plot_trajector()</code>. For this plot, we’ll also set some
distance limits to zoom in to the Florida Ave-U St corridor of the
route.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stop_formatting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>timepoint <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Yes"</span>, <span class="st">"No"</span><span class="op">)</span>,</span>
<span>                              outline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"red1"</span>, <span class="st">"grey30"</span><span class="op">)</span>,</span>
<span>                              shape <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">22</span>, <span class="fl">21</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">florida_U_lims</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9500</span>, <span class="fl">15500</span><span class="op">)</span></span>
<span><span class="va">focus_trips</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">(</span><span class="va">c53_mono</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>                         <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">event_timestamp</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">trip_id_performed</span><span class="op">)</span><span class="op">[</span><span class="fl">17</span><span class="op">:</span><span class="fl">20</span><span class="op">]</span></span></code></pre></div>
<p>Now we can generate our line animation. We’ll use the field
<code>label_field</code> to tell the function to label each stop point
with the <code>stop_name</code> column in <code>c53_stops</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">line_anim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_animated_line.html">plot_animated_line</a></span><span class="op">(</span></span>
<span>  <span class="co"># Add trajectory &amp; feature data</span></span>
<span>  trajectory <span class="op">=</span> <span class="va">c53_traj</span>, feature_distances <span class="op">=</span> <span class="va">c53_stops</span>,</span>
<span>  distance_lim <span class="op">=</span> <span class="va">florida_U_lims</span>, plot_trips <span class="op">=</span> <span class="va">focus_trips</span>,</span>
<span>  <span class="co"># Format features</span></span>
<span>  feature_outline <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_shape <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_size <span class="op">=</span> <span class="fl">2</span>, feature_stroke <span class="op">=</span> <span class="fl">1.25</span>,</span>
<span>  <span class="co"># Add labels</span></span>
<span>  label_field <span class="op">=</span> <span class="st">"stop_name"</span>,</span>
<span>  label_pos <span class="op">=</span> <span class="st">"right"</span>, label_size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  <span class="co"># Format route &amp; vehicles</span></span>
<span>  route_color <span class="op">=</span> <span class="st">"indianred2"</span>,</span>
<span>  veh_alpha <span class="op">=</span> <span class="fl">0.9</span>, timestep <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">line_anim</span></span></code></pre></div>
<p><img src="https://drive.google.com/uc?id=1xIQ5det3ll7-eyvvjGUAPnBRUf20ngBe"><!-- --></p>
</div>
<div class="section level3">
<h3 id="map-animations">Map Animations<a class="anchor" aria-label="anchor" href="#map-animations"></a>
</h3>
<p>The final visualization we’ll make is an animated map. The concept is
similar to the animated line we saw above, but instead of simplifying
the route, we’ll draw it spatially and show the vehicles traveling
through the city.</p>
<p>This function has formatting and feature options very similar to the
previous two visualization functions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map_anim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_animated_line.html">plot_animated_map</a></span><span class="op">(</span></span>
<span>  <span class="co"># Add trajectory, shape, &amp; feature data</span></span>
<span>  trajectory <span class="op">=</span> <span class="va">c53_traj</span>,</span>
<span>  shape_geometry <span class="op">=</span> <span class="va">c53_shape</span>, feature_distances <span class="op">=</span> <span class="va">c53_stops</span>,</span>
<span>  <span class="co"># Format features</span></span>
<span>  feature_outline <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_shape <span class="op">=</span> <span class="va">stop_formatting</span>,</span>
<span>  feature_size <span class="op">=</span> <span class="fl">1.25</span>, feature_stroke <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  <span class="co"># Format route</span></span>
<span>  route_color <span class="op">=</span> <span class="st">"indianred3"</span>, route_width <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  bbox_expand <span class="op">=</span> <span class="fl">700</span></span>
<span><span class="op">)</span></span>
<span><span class="va">map_anim</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin O’Brien, Lewis Lehe.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
