<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Fits continuous trajectory interpolating curves from GTFS schedule data. — get_gtfs_trajectory_fun • transittraj</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Fits continuous trajectory interpolating curves from GTFS schedule data. — get_gtfs_trajectory_fun"><meta name="description" content='This function fits a continuous vehicle trajectory function to scheduled GTFS
stop_times, returning a trajectory object. Interpolation can be done
linearly (interp_method = "linear"), or via any method supported by
stats::splinefun().'><meta property="og:description" content='This function fits a continuous vehicle trajectory function to scheduled GTFS
stop_times, returning a trajectory object. Interpolation can be done
linearly (interp_method = "linear"), or via any method supported by
stats::splinefun().'></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">transittraj</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/data-workflow.html">data-workflow</a></li>
    <li><a class="dropdown-item" href="../articles/input-data.html">input-data</a></li>
    <li><a class="dropdown-item" href="../articles/trajectories.html">trajectories</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/obrien-ben/transittraj/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Fits continuous trajectory interpolating curves from GTFS schedule data.</h1>
      <small class="dont-index">Source: <a href="https://github.com/obrien-ben/transittraj/blob/main/R/trajectory_constructors.R" class="external-link"><code>R/trajectory_constructors.R</code></a></small>
      <div class="d-none name"><code>get_gtfs_trajectory_fun.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>This function fits a continuous vehicle trajectory function to scheduled GTFS
<code>stop_times</code>, returning a trajectory object. Interpolation can be done
linearly (<code>interp_method = "linear"</code>), or via any method supported by
<code><a href="https://rdrr.io/r/stats/splinefun.html" class="external-link">stats::splinefun()</a></code>.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_gtfs_trajectory_fun</span><span class="op">(</span></span>
<span>  <span class="va">gtfs</span>,</span>
<span>  shape_geometry <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  project_crs <span class="op">=</span> <span class="fl">4326</span>,</span>
<span>  date_min <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  date_max <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  agency_timezone <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  use_stop_time <span class="op">=</span> <span class="st">"departure"</span>,</span>
<span>  add_stop_dwell <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  add_distance_error <span class="op">=</span> <span class="fl">0</span>,</span>
<span>  interp_method <span class="op">=</span> <span class="st">"linear"</span>,</span>
<span>  find_inverse_function <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  return_group_function <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  inv_tol <span class="op">=</span> <span class="fl">0.01</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-gtfs">gtfs<a class="anchor" aria-label="anchor" href="#arg-gtfs"></a></dt>
<dd><p>A tidygtfs object.</p></dd>


<dt id="arg-shape-geometry">shape_geometry<a class="anchor" aria-label="anchor" href="#arg-shape-geometry"></a></dt>
<dd><p>Optional. The SF object to project onto. Must include
the field <code>shape_id</code>. See <code><a href="get_shape_geometry.html">get_shape_geometry()</a></code>. Default is NULL, where
all shapes in <code>gtfs</code> will be used.</p></dd>


<dt id="arg-project-crs">project_crs<a class="anchor" aria-label="anchor" href="#arg-project-crs"></a></dt>
<dd><p>Optional. A numeric EPSG identifer indicating the
coordinate system to use for spatial calculations. Consider setting to a
Euclidian projection, such as the appropriate UTM zone. Default is 4326 (WGS
84 ellipsoid).</p></dd>


<dt id="arg-date-min">date_min<a class="anchor" aria-label="anchor" href="#arg-date-min"></a></dt>
<dd><p>Optional. A date object. The earliest date in
<code>calendar.txt</code> to create a trip trajectory for. Default is <code>NULL</code>, where the
first date in <code>calendar.txt</code> will be used.</p></dd>


<dt id="arg-date-max">date_max<a class="anchor" aria-label="anchor" href="#arg-date-max"></a></dt>
<dd><p>Optional. A date object. The latest date in
<code>calendar.txt</code> to create a trip trajectory for. Default is <code>NULL</code>, where the
last date in <code>calendar.txt</code> will be used.</p></dd>


<dt id="arg-agency-timezone">agency_timezone<a class="anchor" aria-label="anchor" href="#arg-agency-timezone"></a></dt>
<dd><p>Optional. A timezone string (see <code><a href="https://rdrr.io/r/base/timezones.html" class="external-link">OlsonNames()</a></code>)
indicating he appropriate timezone for the stop times. Default is <code>NULL</code>,
where the timezone in <code>agency.txt</code> will be used.</p></dd>


<dt id="arg-use-stop-time">use_stop_time<a class="anchor" aria-label="anchor" href="#arg-use-stop-time"></a></dt>
<dd><p>Optional. A string, which stop time column should be
used for the timepoint? Must be one of <code>"arrival"</code> (use <code>arrival_time</code>),
<code>"departure"</code> (use <code>departure_time</code>), or <code>"both"</code>,
(timepoints will be created at both the stop arrival and departure). Default
is <code>"departure"</code>.</p></dd>


<dt id="arg-add-stop-dwell">add_stop_dwell<a class="anchor" aria-label="anchor" href="#arg-add-stop-dwell"></a></dt>
<dd><p>Optional. A numeric. If <code>use_stop_time = "both"</code>,
but scheduled arrival and departure times are equal (i.e., no dwell), how
many seconds of dwell should be added? This will adjust forward the
<code>departure_time</code>. Default is 0.</p></dd>


<dt id="arg-add-distance-error">add_distance_error<a class="anchor" aria-label="anchor" href="#arg-add-distance-error"></a></dt>
<dd><p>Optional. If non-zero, each "flat" observation will
be adjusted by this amount forwards, in units of input <code>distance</code>. Default is
0.</p></dd>


<dt id="arg-interp-method">interp_method<a class="anchor" aria-label="anchor" href="#arg-interp-method"></a></dt>
<dd><p>Optional. The type of interpolation function to be fit.
Either <code>"linear"</code>, or a spline method from <code><a href="https://rdrr.io/r/stats/splinefun.html" class="external-link">stats::splinefun()</a></code>. Default is
<code>"linear"</code>.</p></dd>


<dt id="arg-find-inverse-function">find_inverse_function<a class="anchor" aria-label="anchor" href="#arg-find-inverse-function"></a></dt>
<dd><p>Optional. A boolean, should the numeric inverse
function (time ~ distance) be calculated? Default is <code>TRUE</code>.</p></dd>


<dt id="arg-return-group-function">return_group_function<a class="anchor" aria-label="anchor" href="#arg-return-group-function"></a></dt>
<dd><p>Optional. A boolean, should the returned
trajectory object be grouped into a single function? If FALSE, will return a
list (indexed by <code>trip_id_performed</code>) of single trajectory objects. Default
is <code>TRUE</code>.</p></dd>


<dt id="arg-inv-tol">inv_tol<a class="anchor" aria-label="anchor" href="#arg-inv-tol"></a></dt>
<dd><p>Optional. A numeric in the units of input <code>distance</code>, the
tolerance used when calculating the numeric inverse function. Default is
0.01.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>If <code>return_group_function = TRUE</code>, a grouped trajectory object. If
<code>FALSE</code>, a list of single trajectory objects, index by their
<code>trip_id_performed</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>

<div class="section">
<h3 id="stops-dwells-and-monotonicity">Stops, Dwells, and Monotonicity<a class="anchor" aria-label="anchor" href="#stops-dwells-and-monotonicity"></a></h3>


<p>To fit an interpolating trajectory function, each observation must include
distance and timestamp pairs throughout each trip. While <code>stop_times</code> does
include a <code>shape_dist_traveled</code> field, this is optional and often left
empty by agencies. Additionally, small distortions in spatial projections
mean that projected GPS points may not align perfectly with the agency's
calculated <code>shape_dist_traveled</code>. As such, this function uses
<code><a href="get_stop_distances.html">get_stop_distances()</a></code> to get the distance of each stop along each shape for
each trip. Alternatively, all stops and trips can be referenced to the
same spatial feature using <code>shape_geometry</code>. Consider setting <code>project_crs</code>
to the same spatial projection used to linearize AVL GPS points.</p>
<p>The trajectory functions are fit using the times a trip is scheduled to
serve each stop. There is some ambiguity here: should a stop's timestamp
be when the vehicle arrives, or departs? This can be controlled using
<code>use_stop_time</code>, set to <code>"departure"</code> for <code>departure_time</code>, <code>"arrival"</code> for
<code>arrival_time</code>, or <code>"both"</code> to include both <code>departure_time</code> and
<code>arrival_time</code> as distinct observations (i.e., distance &amp; timestamp pairs).</p>
<p>Often times, however, a GTFS schedule will not have different <code>arrival_time</code>
and <code>departure_time</code> values, especially if the timetable was not developed
considering stop-level dwell times. In this scenario, it may be best to use
only one of <code>departure_time</code> or <code>arrival_time</code>. If a dwell is desired, use
<code>add_stop_dwell</code> to simulate a dwell time at each stop. This will increase
the <code>departure_time</code> by the number of seconds specified.</p>
<p>Adding dwells opens a new consideration, however: the trajectory will no
longer be strictly monotonic, as the vehicle will hold at a constant distance
for some period of time. This is only a concern if
<code>find_inverse_function = TRUE</code>, which requires strictly monotonic input data.
If both dwell times and an inverse function are desired, consider setting
<code>add_distance_error &gt; 0</code> to restore strict monotonicity. See
<code><a href="make_monotonic.html">make_monotonic()</a></code> for more details.</p>
</div>

<div class="section">
<h3 id="interpolating-methods">Interpolating Methods<a class="anchor" aria-label="anchor" href="#interpolating-methods"></a></h3>


<p>The goal of this function is to fit a continuous function representing a
GTFS trip's scheduled distance traveled as a function of time. This
function supports to types of interpolating curves:</p><ul><li><p>Linear interpolation, for <code>interp_method = "linear"</code>. This will fit a
simple linear function, ignorant of recorded <code>speed</code> values.</p></li>
<li><p>Spline interpolation, for <code>interp_method</code> set to any method supported by
<code><a href="https://rdrr.io/r/stats/splinefun.html" class="external-link">stats::splinefun()</a></code> (i.e., <code>"fmm"</code>, <code>"natural"</code>, <code>"periodic"</code>, <code>"monoH.FC"</code>,
or <code>"hyman"</code>.)</p></li>
</ul><p>By default, <code>interp_method = linear</code>, and linear interpolation is the
recommended method for schedule trajectories. This is because timetable
development typically assumes a constant running speed over a corridor, so
linearly connecting stop times will best reflect a trip's scheduled
trajectory.</p>
</div>

<div class="section">
<h3 id="inverse-functions">Inverse Functions<a class="anchor" aria-label="anchor" href="#inverse-functions"></a></h3>


<p>Often times, we are concerned not with the position of a vehicle at a
particular time, but when a vehicle crosses a specific point in space. This
can be accomplished by computing an inverse trajectory function. If
<code>find_inverse_function = TRUE</code> (the default), a numeric inverse to the fit
trajectory function will be found, with a tolerance controlled by <code>inv_tol</code>.</p>
<p>Because the inverse function is numerical, it can be found for any type of
interpolating curve (linear or spline). However, the input data must be
strictly monotonic for the trajectory curve to be invertible. If
<code>find_inverse_function = TRUE</code>, this will be verified before proceeding (see
<code><a href="validate_monotonicity.html">validate_monotonicity()</a></code>).</p>
</div>

<div class="section">
<h3 id="the-trajectory-object">The Trajectory Object<a class="anchor" aria-label="anchor" href="#the-trajectory-object"></a></h3>


<p>A trajectory function does not exist by itself; rather, it requires the
context about the trip it describes, as well as its inverse function. As
such, <code><a href="get_trajectory_fun.html">get_trajectory_fun()</a></code> returns an AVL trajectory object. If
<code>return_group_function = TRUE</code> (the default), the function will return a
single object containing:</p><ul><li><p>A vector of <code>trip_id_performed</code>s, from the <code>trip_id</code>s found in <code>trips</code>.</p></li>
<li><p>A list of fit trajectory functions, indexed by their <code>trip_id_performed</code>.</p></li>
<li><p>A list of fit inverse trajectory functions, indexed by their
<code>trip_id_performed</code>.</p></li>
<li><p>Information about how the trajectory and inverse trajectory functions were
fit, including <code>interp_method</code>, <code>use_speeds</code>, and <code>inv_tol</code>.</p></li>
<li><p>A vector each for the minimum distances, maximum distances, minimum times,
and maximum times of each trip. These inform the domain and range of the
trajectory function and its inverse, preventing extrapolation beyond the
time or distance range actually served by a trip.</p></li>
</ul><p>Alternatively, if <code>return_group_function = FALSE</code>, a separate trajectory
object will be fit for each trip. <code><a href="get_trajectory_fun.html">get_trajectory_fun()</a></code> will return a list
of trajectory objects indexed by their <code>trip_id_performed</code>.</p>
<p>More information about the trajectory object classes and how to use them is
available at (xyz).</p>
</div>

    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Benjamin O’Brien, Lewis Lehe.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  </body></html>

